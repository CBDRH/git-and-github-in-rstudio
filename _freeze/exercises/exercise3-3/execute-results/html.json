{
  "hash": "44d040513832ca26a3ea74f4b4b4392b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Part 2. Adding text labels\"\nformat: \n  html:\n    execute:\n      echo: true\n      warning: false\n      results: hide\nnumber-sections: true   \nfilters:\n  - line-highlight\n---\n\n::: {.cell}\n\n:::\n\n\n\n# Overview\n\nWe have a lot done but more to do. In this section we will work on adding text labels to the stacked column chart\n\n::: {#fig-preogress1 layout-ncol=2}\n\n![Where we are up to](../images/fig1-checkpoint1.png){#fig-checkpoint1}\n\n![The final goal](../images/self-assessed-health.png){#fig-chart1}\n\n:::\n\nIf you have successfully navigated the previous section, your code should look a bit like the code below:\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n#\n###############################################################\n# Project:  National Health Survey 2022 Analysis\n# Purpose:  Plot self-assessed health data by state\n# Inputs:   exercises/3-clean-data/vis1.Rda\n# Outputs:  exercises/4-outputs/yyyy-mm-dd-self-assessed-health.png\n# Author:   Mark Hanly\n###############################################################\n\n###############\n# Preparation #\n###############\n\n# Load libraries\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(forcats)\nlibrary(RColorBrewer)\n\n# Load cleaned data\nload('exercises/3-clean-data/vis1.Rda')\n\n# Create variable indicating % very good or excellent health\ndf1Plot <- df1Clean |>\n  group_by(state) |>\n  slice(4:5) |>\n  summarise(totalHealthy = sum(percent)) |>\n  left_join(df1Clean, by = 'state')\n\n# Custom bar colours\nbarCols <- RColorBrewer::brewer.pal(5, 'RdYlGn')\n\n#####################\n# Plotting the data #\n#####################\n\nggplot(\n  data=df1Plot,\n  aes(x = percent, \n      y = fct_reorder(state, totalHealthy), \n      fill=status)) + \n  geom_col(position = position_stack(reverse = TRUE),\n           color = \"white\") +\n  scale_fill_manual(name = NULL,\n                    values = barCols) +\n  scale_y_discrete(NULL) +\n  scale_x_continuous(NULL) +\n  labs(\n    title = 'Victorians most likely to rate their health as Excellent or Very Good',\n    subtitle = 'Self-assessed health status by states and territories',\n    caption = 'Source: National Health Survey, 2022') +\n  theme(\n    plot.title.position = 'plot',\n    panel.background = element_blank(),\n    axis.ticks.y = element_blank()\n  )\n```\n:::\n\n\nYou can copy-paste this code into your script if you want to start from this point in the exercise. \n\n<hr>\n\n# Add text labels\n\nLet's dive right in and add text labels using `geom_text()`. There are two things to be aware of as we do this:\n\n1. `geom_text()` has a required aesthetic `label` which we have not specified so far. The `label` aesthetic maps a variable to the text label that appears on the chart; in our case that will be the variable **percent**. So we will add `label = percent` to the other aesthetic mappings in `aes()`. \n\n2. In the last section we set `position = position_stack(reverse = TRUE)` to reverse the order of the health categories in `geom_col()`. To make sure the labels match the categories we will have to do the same thing here for `geom_text()`.  \n\n\n::: {.cell source-line-numbers='7,10'}\n\n```{.r .numberLines .cell-code  code-fold=\"true\"}\n# Add geom_text\nggplot(\n  data=df1Plot,\n  aes(x = percent, \n      y = fct_reorder(state, totalHealthy), \n      fill = status,\n      label = percent)) + \n  geom_col(position = position_stack(reverse = TRUE),\n           color = \"white\") +\n  geom_text(position = position_stack(reverse = TRUE)) +\n  scale_fill_manual(name = NULL,\n                    values = barCols) +\n  scale_y_discrete(NULL) +\n  scale_x_continuous(NULL) +\n  labs(\n    title = 'Victorians most likely to rate their health as Excellent or Very Good',\n    subtitle = 'Self-assessed health status by states and territories',\n    caption = 'Source: National Health Survey, 2022') +\n  theme(\n    plot.title.position = 'plot',\n    panel.background = element_blank(),\n    axis.ticks.y = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](exercise3-3_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n<hr>\n\n# Format the text labels\n\nOkay, this is a start but also obviously gross. There are a few arguments we can quickly add to `geom_text()` to make things look better.\n\n* `size = 8/.pt` will reduce the font size to 8 points\n* `hjust = 1.1` will add some horizontal justification, shifting the labels towards the end of their bars\n* `color = grey30` will apply a lighter shade of grey\n\n::: {.aside}\n`.pt` is an internal constant in R that allows us to convert millimeters (mm) to point size. In `geom_text()`, the size is defined in mm. Setting `size = 8/.pt` is a quick way of figuring how many mm we need to get a font size of 8 points (which is about the smallest font size that can be comfortably read). To test this you can enter 8/.pt at the console. \n:::\n\n\n::: {.cell source-line-numbers='12-14'}\n\n```{.r .numberLines .cell-code  code-fold=\"true\"}\n# Tidy up the text labels\nggplot(\n  data=df1Plot,\n  aes(x = percent, \n      y = fct_reorder(state, totalHealthy), \n      fill = status,\n      label = percent)) + \n  geom_col(position = position_stack(reverse = TRUE),\n           color = \"white\") +\n  geom_text(\n    position = position_stack(reverse = TRUE),\n    size = 8/.pt, \n    hjust = 1.1,\n    color='grey30') +\nscale_fill_manual(name = NULL,\n                  values = barCols) +\n  scale_y_discrete(NULL) +\n  scale_x_continuous(NULL) +\n  labs(\n    title = 'Victorians most likely to rate their health as Excellent or Very Good',\n    subtitle = 'Self-assessed health status by states and territories',\n    caption = 'Source: National Health Survey, 2022') +\n  theme(\n    plot.title.position = 'plot',\n    panel.background = element_blank(),\n    axis.ticks.y = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](exercise3-3_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n<hr>\n\n# Format the labels\n\nThis is a step in the right direction. Another improvement would be to nicely format the labels so that the number of decimal places is always the same, i.e. **26** should appear as **26.0**. We can also add a % symbol so we get **26.0%**.\n\nRather than change the underlying data, we can make both of these changes on the fly in the ggplot code by updating how the label aesthetic is defined. In particular, we will set `label = paste0(format(percent, nsmall=1), '%')`. \n\n::: {.aside}\nTo see what this is doing try breaking it into two steps and entering the following at the console:<ol><li>`format(26, nsmall=1)`</li><li>`paste0(\"26.0\", \"%\")`</li></ol>\n:::\n\n\n::: {.cell source-line-numbers='7'}\n\n```{.r .numberLines .cell-code  code-fold=\"true\"}\n# Format the text labels\nggplot(\n  data=df1Plot,\n  aes(x = percent, \n      y = fct_reorder(state, totalHealthy), \n      fill = status,\n      label = paste0(format(percent, nsmall=1), '%'))) + \n  geom_col(position = position_stack(reverse = TRUE),\n           color = \"white\") +\n  geom_text(\n    position = position_stack(reverse = TRUE),\n    size = 8/.pt, \n    hjust = 1.1,\n    color='grey30') +\n  scale_fill_manual(name = NULL,\n                    values = barCols) +\n  scale_y_discrete(NULL) +\n  scale_x_continuous(NULL) +\n  labs(\n    title = 'Victorians most likely to rate their health as Excellent or Very Good',\n    subtitle = 'Self-assessed health status by states and territories',\n    caption = 'Source: National Health Survey, 2022') +\n  theme(\n    plot.title.position = 'plot',\n    panel.background = element_blank(),\n    axis.ticks.y = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](exercise3-3_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n<hr>\n\n# Adjust the colours\n\nThis is better but there are still a few problems:\n\n* The grey colour of the text labels works quite nicely against the yellow background but not so good against the dark green background. \n\n* There isn't really room for text labels for the **Poor** category.\n\nWe can tackle both of these issues by adjusting the label text colour for each health category. We will customise the text colours choosing ones that contrasts well against the background fill colors. For the **Poor** category, we will simply set the colour to be transparent. \n\nA convenient way to choose contrasting colours is to use the `lighten()` and `darken()` functions from the `colorspace` package. These functions take one or more R colours and lighten or darken them by a specified amount. For example, the following code returns <span style=\"color:#FF6363; font-weight:600;\">#FF6363</span>, a shade of red that is 20% lighter than the original.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(colorspace)\n\nlighten(\"red\", 0.2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"#FF6363\"\n```\n\n\n:::\n:::\n\n\n::: {.callout-tip collapse=\"true\"}\n\n## Expand To Learn More About `lighten()` and `darken()`\n\nWe can make colors progressively lighter using `lighten()`:\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# 6 shades lighter\nlighter6 <- lighten(\"forestgreen\", c(0, .2, .4, .6, .8, 1))\n\n# Visualise the results\nscales::show_col(lighter6)\n```\n\n::: {.cell-output-display}\n![](exercise3-3_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nWe can make colors progressively darker using `darken()`:\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# 6 shades darker\ndarker6 <- darken(\"forestgreen\", c(0, .2, .4, .6, .8, 1))\n\n# Visualise the results\nscales::show_col(darker6)\n```\n\n::: {.cell-output-display}\n![](exercise3-3_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n:::\n\nAdd the following code snippet to your file, above the ggplot code. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Move this to the top!\nlibrary(colorspace) \n\n# Custom colors for bar labels \nlabel_text_colors <- c('transparent',\n                       darken(barCols[2], 0.4),\n                       darken(barCols[3], 0.4),\n                       darken(barCols[4], 0.4),\n                       lighten(barCols[5], 0.6))\n```\n:::\n\n\n* The first position corresponds to <span style=\"color:#D7191C; font-weight: 600;\">Poor</span> so we set that to transparent. \n\n* The next three positions correspond to <span style=\"color:#FDAE61; font-weight: 600;\">Fair</span>, <span style=\"color:#FFFFBF; font-weight: 600; background-color: lightgrey;\">Good</span> and <span style=\"color:#A6D96A; font-weight: 600;\">Very good</span> so we will make the text labels 40% darker.\n\n* The final position corresponds to <span style=\"color:#1A9641; font-weight: 600;\">Excellent</span>, which is already quite dark so we will make the label colour 60% lighter. \n\nWe can now map the label colours to this new vector by adding `scale_colour_manual(\"\", values = label_text_colors)`.  To make this work we will also have to delete `color='grey30'` from the call to `geom_text()` and add `color = status` to `aes()`.\n\n\n::: {.cell source-line-numbers='7,16'}\n\n```{.r .numberLines .cell-code  code-fold=\"true\"}\n# Adjust label colours\nggplot(\n  data=df1Plot,\n  aes(x = percent, \n      y = fct_reorder(state, totalHealthy), \n      fill = status,\n      color = status,\n      label = paste0(format(percent, nsmall=1), '%'))) + \n  geom_col(position = position_stack(reverse = TRUE),\n           color = \"white\") +\n  geom_text(\n    position = position_stack(reverse = TRUE),\n    size = 8/.pt, \n    hjust = 1.1) +\n  scale_fill_manual(name = NULL, values = barCols) +\n  scale_colour_manual(\"\", values = label_text_colors) +\n  scale_y_discrete(NULL) +\n  scale_x_continuous(NULL) +\n  labs(\n    title = 'Victorians most likely to rate their health as Excellent or Very Good',\n    subtitle = 'Self-assessed health status by states and territories',\n    caption = 'Source: National Health Survey, 2022') +\n  theme(\n    plot.title.position = 'plot',\n    panel.background = element_blank(),\n    axis.ticks.y = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](exercise3-3_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n<hr>\n\n# Remove the legend \n\nThe labels are looking good but now we have two separate legends, one for the column fill colour and one for the label text colour. We will handle the legend in a later step so for now let's just get rid of the legend. There are a few ways of doing this but perhaps the easiest is setting `legend.position = \"none\"` in the `theme()`. \n\n\n::: {.cell source-line-numbers='27'}\n\n```{.r .numberLines .cell-code  code-fold=\"true\"}\n# Remove the legend\nggplot(\n  data=df1Plot,\n  aes(x = percent, \n      y = fct_reorder(state, totalHealthy), \n      fill = status,\n      color = status,\n      label = paste0(format(percent, nsmall=1), '%'))) + \n  geom_col(position = position_stack(reverse = TRUE),\n           color = \"white\") +\n  geom_text(\n    position = position_stack(reverse = TRUE),\n    size = 8/.pt, \n    hjust = 1.1) +\n  scale_fill_manual(name = NULL, values = barCols) +\n  scale_colour_manual(\"\", values = label_text_colors) +\n  scale_y_discrete(NULL) +\n  scale_x_continuous(NULL) +\n  labs(\n    title = 'Victorians most likely to rate their health as Excellent or Very Good',\n    subtitle = 'Self-assessed health status by states and territories',\n    caption = 'Source: National Health Survey, 2022') +\n  theme(\n    plot.title.position = 'plot',\n    panel.background = element_blank(),\n    axis.ticks.y = element_blank(),\n    legend.position = \"none\"\n  )\n```\n\n::: {.cell-output-display}\n![](exercise3-3_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}